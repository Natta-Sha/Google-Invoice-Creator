<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <title id="dynamic-title">Invoice Form</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .form-label {
        font-weight: bold;
      }
      .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.1rem rgba(220, 53, 69, 0.25) !important;
      }
      .icon-button {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: #6c757d;
        transition: transform 0.15s ease, color 0.15s ease;
      }
      .icon-button i {
        transition: transform 0.15s ease, color 0.15s ease;
      }
      .icon-button:hover i {
        color: #000 !important;
        transform: scale(1.2);
      }
      .icon-button:focus {
        outline: none;
        box-shadow: none;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body class="container py-4">
    <div class="mb-4 d-flex justify-content-between">
      <a href="<?= baseUrl ?>?page=Home" class="btn btn-link"
        >&larr; Back to Main Page</a
      >
      <a
        href="<?= baseUrl ?>?page=InvoicesList"
        class="btn btn-link"
        id="back-to-list"
        >&larr; Back to Invoices List</a
      >
    </div>
    <h2 class="mb-4" id="page-title">Invoice Form</h2>
    <div id="delete-section" style="display: none">
      <button id="delete-btn" class="btn btn-danger">Delete</button>
      <div
        id="delete-spinner"
        class="spinner-border text-danger ms-3"
        style="display: none"
        role="status"
      >
        <span class="visually-hidden">Deleting...</span>
      </div>
    </div>
    <div
      class="modal fade"
      id="deleteModal"
      tabindex="-1"
      aria-labelledby="deleteModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Are you sure that you want to delete?</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              No
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              Yes
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Invoice details and items table will be inserted here (copied from InvoiceGenerator.html) -->
    <div id="invoice-form-content"></div>
    <script>
      const invoiceId =
        "<?= typeof invoiceId !== 'undefined' ? invoiceId : '' ?>";
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get("mode") || "view";
      function setFormMode(mode) {
        let title = "Invoice Form";
        if (mode === "view") title = "Invoice - View";
        if (mode === "delete") title = "Invoice - Delete";
        document.getElementById("page-title").textContent = title;
        document.title = title;
        document.getElementById("delete-section").style.display =
          mode === "delete" ? "block" : "none";
      }
      function setFieldsReadOnly(readonly) {
        document.querySelectorAll("input, textarea").forEach((el) => {
          el.disabled = readonly;
        });
        // Hide add row button in view/delete
        const addRowBtn = document.getElementById("add-row-btn");
        if (addRowBtn) addRowBtn.style.display = readonly ? "none" : "block";
      }
      function fillForm(data) {
        // This function should fill all fields as in InvoiceGenerator.html
        // ...
      }
      window.onload = function () {
        setFormMode(mode);
        if (invoiceId) {
          google.script.run
            .withSuccessHandler(function (data) {
              fillForm(data);
              setFieldsReadOnly(mode === "view" || mode === "delete");
            })
            .getInvoiceDataById(invoiceId);
        } else {
          setFieldsReadOnly(mode === "view" || mode === "delete");
        }
        // Delete button logic
        const deleteBtn = document.getElementById("delete-btn");
        if (deleteBtn) {
          deleteBtn.onclick = function () {
            const modal = new bootstrap.Modal(
              document.getElementById("deleteModal")
            );
            modal.show();
            document.getElementById("confirmDeleteBtn").onclick = function () {
              modal.hide();
              document.getElementById("delete-spinner").style.display =
                "inline-block";
              google.script.run
                .withSuccessHandler(function (result) {
                  document.getElementById("delete-spinner").style.display =
                    "none";
                  if (result.success) {
                    window.location.href = "?page=InvoicesList";
                  } else {
                    alert(result.message || "Error deleting invoice.");
                  }
                })
                .deleteInvoiceById(invoiceId);
            };
          };
        }
      };
    </script>
  </body>
</html>
