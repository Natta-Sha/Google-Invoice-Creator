<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <title>Invoice Viewer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="container py-4">
    <a href="<?= baseUrl ?>?page=InvoicesList" class="btn btn-link mb-3"
      >‚Üê Back to Invoice List</a
    >

    <h2>Invoice Viewer</h2>

    <div class="mb-4">
      <strong>Project Name:</strong> <span id="project_name"></span><br />
      <strong>Invoice Number:</strong> <span id="invoice_number"></span><br />
      <strong>Invoice Date:</strong> <span id="invoice_date"></span><br />
      <strong>Due Date:</strong> <span id="due_date"></span><br />
      <strong>Client Name:</strong> <span id="client_name"></span><br />
      <strong>Client Address:</strong> <span id="client_address"></span><br />
      <strong>Client Number:</strong> <span id="client_number"></span><br />
      <strong>Our Company:</strong> <span id="our_company"></span><br />
      <strong>Tax Rate (%):</strong> <span id="tax"></span><br />
      <strong>Currency:</strong> <span id="currency"></span><br />
      <strong>Bank Details 1:</strong>
      <pre id="bank_details_1"></pre>
      <br />
      <strong>Bank Details 2:</strong>
      <pre id="bank_details_2"></pre>
      <br />
      <strong>Comment:</strong> <span id="comment"></span><br />
    </div>

    <h3>Items</h3>
    <table class="table table-bordered" id="items_table">
      <thead>
        <tr>
          <th>#</th>
          <th>Service</th>
          <th>Period</th>
          <th>Quantity</th>
          <th>Rate/hour</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody id="items_body"></tbody>
    </table>

    <script>
      window.onload = function () {
        const params = new URLSearchParams(window.location.search);
        const invoiceId = params.get("id");
        if (!invoiceId) {
          alert("Invoice ID is missing.");
          return;
        }
        google.script.run
          .withSuccessHandler(fillInvoice)
          .getInvoiceById(invoiceId);
      };

      function fillInvoice(data) {
        if (!data) {
          alert("Invoice not found.");
          return;
        }

        document.getElementById("project_name").textContent =
          data["Project Name"] || "";
        document.getElementById("invoice_number").textContent =
          data["Invoice Number"] || "";
        document.getElementById("invoice_date").textContent = formatDate(
          data["Invoice Date"]
        );
        document.getElementById("due_date").textContent = formatDate(
          data["Due Date"]
        );
        document.getElementById("client_name").textContent =
          data["Client Name"] || "";
        document.getElementById("client_address").textContent =
          data["Client Address"] || "";
        document.getElementById("client_number").textContent =
          data["Client Number"] || "";
        document.getElementById("our_company").textContent =
          data["Our Company"] || "";
        document.getElementById("tax").textContent = data["Tax Rate (%)"] || "";
        document.getElementById("currency").textContent =
          data["Currency"] || "";
        document.getElementById("bank_details_1").textContent =
          data["Bank Details 1"] || "";
        document.getElementById("bank_details_2").textContent =
          data["Bank Details 2"] || "";
        document.getElementById("comment").textContent = data["Comment"] || "";

        const tbody = document.getElementById("items_body");
        tbody.innerHTML = "";

        for (let i = 1; i <= 20; i++) {
          if (!data[`Row ${i} #`]) continue;

          const tr = document.createElement("tr");

          const cells = [
            data[`Row ${i} #`] || "",
            data[`Row ${i} Service`] || "",
            data[`Row ${i} Period`] || "",
            data[`Row ${i} Quantity`] || "",
            data[`Row ${i} Rate/hour`] || "",
            data[`Row ${i} Amount`] || "",
          ];

          cells.forEach((text) => {
            const td = document.createElement("td");
            td.textContent = text;
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        }
      }

      function formatDate(value) {
        if (!value) return "";
        const date = new Date(value);
        if (isNaN(date)) return value;
        const dd = String(date.getDate()).padStart(2, "0");
        const mm = String(date.getMonth() + 1).padStart(2, "0");
        const yyyy = date.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }
    </script>
  </body>
</html>
