<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <title>Diagnostics - Invoice App</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .diagnostic-result {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin: 1rem 0;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .error {
        color: #dc3545;
      }
      .success {
        color: #198754;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1>üîß Application Diagnostics</h1>
      <p class="text-muted">
        This page helps diagnose issues with the invoice application.
      </p>

      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Service Status</h5>
            </div>
            <div class="card-body">
              <button id="testServicesBtn" class="btn btn-primary mb-3">
                Test Services
              </button>
              <div
                id="servicesResult"
                class="diagnostic-result"
                style="display: none"
              ></div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Full Diagnostics</h5>
            </div>
            <div class="card-body">
              <button id="runDiagnosticsBtn" class="btn btn-success mb-3">
                Run Full Diagnostics
              </button>
              <div
                id="diagnosticsResult"
                class="diagnostic-result"
                style="display: none"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>Quick Tests</h5>
            </div>
            <div class="card-body">
              <button
                id="testProjectNamesBtn"
                class="btn btn-outline-primary me-2"
              >
                Test Project Names
              </button>
              <button id="testConfigBtn" class="btn btn-outline-secondary me-2">
                Test Config
              </button>
              <button id="testLoggerBtn" class="btn btn-outline-info">
                Test Logger
              </button>

              <div
                id="quickTestResult"
                class="diagnostic-result mt-3"
                style="display: none"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <a href="<?= baseUrl ?>?page=Home" class="btn btn-secondary"
          >‚Üê Back to Home</a
        >
      </div>
    </div>

    <script>
      function showResult(elementId, content, isError = false) {
        const element = document.getElementById(elementId);
        element.textContent = content;
        element.style.display = "block";
        element.className = `diagnostic-result ${
          isError ? "error" : "success"
        }`;
      }

      function showLoading(elementId) {
        const element = document.getElementById(elementId);
        element.textContent = "Loading...";
        element.style.display = "block";
        element.className = "diagnostic-result";
      }

      document
        .getElementById("testServicesBtn")
        .addEventListener("click", function () {
          showLoading("servicesResult");
          google.script.run
            .withSuccessHandler(function (result) {
              showResult("servicesResult", result);
            })
            .withFailureHandler(function (error) {
              showResult("servicesResult", `Error: ${error.message}`, true);
            })
            .testServices();
        });

      document
        .getElementById("runDiagnosticsBtn")
        .addEventListener("click", function () {
          showLoading("diagnosticsResult");
          google.script.run
            .withSuccessHandler(function (result) {
              showResult("diagnosticsResult", JSON.stringify(result, null, 2));
            })
            .withFailureHandler(function (error) {
              showResult("diagnosticsResult", `Error: ${error.message}`, true);
            })
            .runDiagnostics();
        });

      document
        .getElementById("testProjectNamesBtn")
        .addEventListener("click", function () {
          showLoading("quickTestResult");
          google.script.run
            .withSuccessHandler(function (result) {
              showResult(
                "quickTestResult",
                `Project names (${result.length}):\n${result.join("\n")}`
              );
            })
            .withFailureHandler(function (error) {
              showResult(
                "quickTestResult",
                `Error getting project names: ${error.message}`,
                true
              );
            })
            .getProjectNames();
        });

      document
        .getElementById("testConfigBtn")
        .addEventListener("click", function () {
          showLoading("quickTestResult");
          google.script.run
            .withSuccessHandler(function (result) {
              showResult(
                "quickTestResult",
                `Config test successful!\nFolder ID: ${result.folderId}\nSpreadsheet ID: ${result.spreadsheetId}`
              );
            })
            .withFailureHandler(function (error) {
              showResult(
                "quickTestResult",
                `Config test failed: ${error.message}`,
                true
              );
            })
            .testConfig();
        });

      document
        .getElementById("testLoggerBtn")
        .addEventListener("click", function () {
          showLoading("quickTestResult");
          const testMessage = `Test from diagnostics page at ${new Date().toISOString()}`;
          google.script.run
            .withSuccessHandler(function (result) {
              showResult(
                "quickTestResult",
                `Logger test successful!\nMessage sent: ${testMessage}`
              );
            })
            .withFailureHandler(function (error) {
              showResult(
                "quickTestResult",
                `Logger test failed: ${error.message}`,
                true
              );
            })
            .testLogger(testMessage);
        });
    </script>
  </body>
</html>
