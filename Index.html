<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script>
      function addRow() {
        const tbody = document.getElementById("invoice-body");
        const rowNumber = tbody.rows.length + 1;
        const row = tbody.insertRow();

        for (let i = 0; i < 6; i++) {
          const cell = row.insertCell();
          const input = document.createElement("input");
          input.className = "form-control";
          input.type = "text";

          if (i === 0) input.value = rowNumber;
          if (i === 5) {
            input.classList.add("amount");
            input.onfocus = markManualAmount;
          }

          input.oninput = updateTotals;
          cell.appendChild(input);
        }
      }

      function updateTotals() {
        const tbody = document.getElementById("invoice-body");
        let subtotal = 0;

        for (let i = 0; i < tbody.rows.length; i++) {
          const row = tbody.rows[i];
          const inputs = row.getElementsByTagName("input");
          const qty = parseFloat(inputs[3].value) || 0;
          const rate = parseFloat(inputs[4].value) || 0;
          const amountCell = inputs[5];

          if (!amountCell.hasAttribute("manual")) {
            amountCell.value = (qty * rate).toFixed(2);
          }

          const amount = parseFloat(amountCell.value) || 0;
          subtotal += amount;
        }

        document.getElementById("subtotal").innerText = subtotal.toFixed(2);

        const tax = parseFloat(document.getElementById("tax").value) || 0;
        const total = subtotal + (subtotal * tax) / 100;
        document.getElementById("total").innerText = total.toFixed(2);

        const exchangeRate = parseFloat(
          document.getElementById("exchange_rate").value
        );
        if (exchangeRate > 0) {
          document.getElementById("amount_in_eur").innerText = (
            total / exchangeRate
          ).toFixed(2);
        } else {
          document.getElementById("amount_in_eur").innerText = "0.00";
        }
      }

      function markManualAmount(e) {
        e.target.setAttribute("manual", "true");
      }

      function submitForm() {
        document.getElementById("generate-btn").disabled = true;
        document.getElementById("spinner").style.display = "inline-block";
        document.getElementById("result").innerHTML = "";

        const data = {
          invoiceNumber: document.getElementById("invoice_number").value.trim(),
          clientName: document.getElementById("client_name").value.trim(),
          clientAddress: document.getElementById("client_address").value.trim(),
          clientNumber: document.getElementById("client_number").value.trim(),
          invoiceDate: document.getElementById("invoice_date").value.trim(),
          dueDate: document.getElementById("due_date").value.trim(),
          tax: document.getElementById("tax").value.trim(),
          subtotal: document.getElementById("subtotal").innerText.trim(),
          total: document.getElementById("total").innerText.trim(),
          exchangeRate: document.getElementById("exchange_rate").value.trim(),
          currency: document.getElementById("currency").value.trim(),
          amountInEUR: document
            .getElementById("amount_in_eur")
            .innerText.trim(),
          bankDetails1: document.getElementById("bank_details_1").value.trim(),
          bankDetails2: document.getElementById("bank_details_2").value.trim(),
          items: [],
        };

        const tbody = document.getElementById("invoice-body");
        for (let i = 0; i < tbody.rows.length; i++) {
          const row = tbody.rows[i]; // <-- ЭТО добавили
          const inputs = row.getElementsByTagName("input");
          const rowData = [];
          for (let input of inputs) {
            rowData.push(input.value.trim());
          }
          data.items.push(rowData);
        }

        google.script.run
          .withSuccessHandler(function (result) {
            document.getElementById("spinner").style.display = "none";
            document.getElementById("result").innerHTML = `
      <div class="alert alert-success mt-4">
        <strong>Invoice created!</strong><br>
        <a href="${result.docUrl}" class="btn btn-outline-secondary mt-2" target="_blank">Open Google Doc</a>
        <a href="${result.pdfUrl}" class="btn btn-outline-secondary mt-2" target="_blank">Open PDF</a>
      </div>
    `;
          })
          .processForm(data);
      }
    </script>
  </head>
  <body class="container py-4">
    <h2 class="mb-4">Create Invoice</h2>

    <!-- Invoice details -->
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Invoice Number</label>
        <input id="invoice_number" type="text" class="form-control" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Client Name</label>
        <input id="client_name" type="text" class="form-control" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Client Address</label>
        <input id="client_address" type="text" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Client Number</label>
        <input id="client_number" type="text" class="form-control" />
      </div>
    </div>

    <!-- Dates and currency -->
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Invoice Date</label>
        <input id="invoice_date" type="date" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Due Date</label>
        <input id="due_date" type="date" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Exchange Rate</label>
        <input
          id="exchange_rate"
          type="number"
          step="0.0001"
          class="form-control"
          value="1.0000"
          oninput="updateTotals()"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">Currency</label>
        <select id="currency" class="form-select">
          <option value="$">$ (USD)</option>
          <option value="€">€ (EUR)</option>
        </select>
      </div>
    </div>

    <!-- Bank Details -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Bank Details 1</label>
        <textarea id="bank_details_1" class="form-control" rows="2"></textarea>
      </div>
      <div class="col-md-6">
        <label class="form-label">Bank Details 2</label>
        <textarea id="bank_details_2" class="form-control" rows="2"></textarea>
      </div>
    </div>

    <!-- Items table -->
    <table class="table table-bordered" id="invoice-table">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Service</th>
          <th>Period</th>
          <th>Quantity</th>
          <th>Rate/hour</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody id="invoice-body">
        <tr>
          <td><input type="text" class="form-control" value="1" /></td>
          <td><input type="text" class="form-control" /></td>
          <td><input type="text" class="form-control" /></td>
          <td>
            <input type="text" class="form-control" oninput="updateTotals()" />
          </td>
          <td>
            <input type="text" class="form-control" oninput="updateTotals()" />
          </td>
          <td>
            <input
              type="text"
              class="form-control amount"
              onfocus="markManualAmount(event)"
            />
          </td>
        </tr>
      </tbody>
    </table>

    <button class="btn btn-outline-primary mb-3" onclick="addRow()">
      + Add Row
    </button>

    <!-- Totals -->
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Tax (%)</label>
        <input
          id="tax"
          type="number"
          class="form-control"
          value="19"
          oninput="updateTotals()"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">Subtotal</label>
        <p class="form-control-plaintext" id="subtotal">0.00</p>
      </div>
      <div class="col-md-3">
        <label class="form-label">Total</label>
        <p class="form-control-plaintext" id="total">0.00</p>
      </div>
      <div class="col-md-3">
        <label class="form-label">Amount in EUR</label>
        <p class="form-control-plaintext" id="amount_in_eur">0.00</p>
      </div>
    </div>

    <!-- Submit button -->
    <div class="row mt-4">
      <div class="col-md-12 text-end">
        <button
          id="generate-btn"
          class="btn btn-success"
          onclick="submitForm()"
        >
          Generate Invoice
        </button>
        <div
          id="spinner"
          class="spinner-border text-primary ms-3"
          style="display: none"
          role="status"
        >
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>

    <div id="result" class="mt-4"></div>
  </body>
</html>
